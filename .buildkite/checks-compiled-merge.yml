env:
  LC_ALL: "en_US.UTF-8"
  NIX_PATH: "channel:nixos-21.11"

  # Per-container variables
  SCRATCH_DIR: "/scratch/cardano-wallet"
  BUILD_DIR: "/build/cardano-wallet"
  CABAL_DIR: "/build/cardano-wallet.cabal"
  XDG_STATE_HOME: "/build/cardano-wallet/.state"
  XDG_CACHE_HOME: "/build/cardano-wallet/.cache"
  TESTS_LOGDIR: "/build/cardano-wallet/integration-test-logs"

  # Per-host variables - shared across containers on host
  CACHE_DIR: "/cache/cardano-wallet"
  macos: "x86_64-darwin"
  linux: "x86_64-linux"

steps:

  # linux 
  - label: 'Check auto-generated Nix on linux'
    key: linux-nix
    commands:
      - './nix/regenerate.sh'
    agents:
      system: ${linux}

  - block: "Proceed with integration tests on linux"
    prompt: "Clicking this button will proceed with integration tests"
    key: trigger_integration_tests
    depends_on:
      - linux-nix

  - label: 'Run integration tests on linux'
    depends_on: trigger_integration_tests
    command: 'nix build -L .#ci.${linux}.tests.run.integration'
    agents:
      system: ${linux}

  # macos
  # TODO: Currently does not work due to nix version too old on
  # build agents?
  #
  # - label: 'Check auto-generated Nix on macos'
  #   key: macos-nix
  #   commands:
  #     - './nix/regenerate.sh'
  #   agents:
  #     system: ${macos}

  # - label: 'Build all tests on macos'
  #   depends_on: macos-nix
  #   command: 'nix build .#ci.${macos}.tests.build'
  #   agents:
  #     system: ${macos}

  # - label: 'Run unit tests on macos'
  #   key: macos-checks-runUnit
  #   depends_on: macos-nix
  #   command: 'nix build -L .#ci.${macos}.tests.run.unit'
  #   agents:
  #     system: ${macos}
